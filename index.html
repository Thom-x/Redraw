<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<title>Redraw</title>
	<link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="css/style.css">
</head>
<body>
	<nav class="navbar navbar-default">
	  <div class="container-fluid">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
	        <span class="sr-only">Toggle navigation</span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	      </button>
	      <a class="navbar-brand" href="#">Redraw</a>
	    </div>
		<form class="navbar-form navbar-left" role="search">
	        <div class="form-group">
	        	<input id="nickname" type="text" class="form-control" placeholder="Nickname">
	        </div>
      	</form>
	    <!-- Collect the nav links, forms, and other content for toggling -->
	    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	      <ul class="nav navbar-nav">
	        <!-- <li class="active"><a href="#">Join <span class="sr-only">(current)</span></a></li> -->
<!-- 	        <li class="dropdown">
	          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Dropdown <span class="caret"></span></a>
	          <ul class="dropdown-menu" role="menu">
	            <li><a href="#">Action</a></li>
	            <li><a href="#">Another action</a></li>
	            <li><a href="#">Something else here</a></li>
	            <li class="divider"></li>
	            <li><a href="#">Separated link</a></li>
	            <li class="divider"></li>
	            <li><a href="#">One more separated link</a></li>
	          </ul>
	        </li> -->
	      </ul>
	    </div><!-- /.navbar-collapse -->
	  </div><!-- /.container-fluid -->
	</nav>

	<div class="container-fluid">
		<div id="counter"></div>
		<div class="row">
			<div id="message" class="col-md-12 text-center"><h2>Waiting for players ...</h2></div>
			<div class="col-md-6 text-center">
				<div id="game" class="col-md-12">
					<div class="col-md-6">
						<h4>Reference :</h4>
						<canvas id="canvas1" width="100px" height="100px"></canvas>
					</div>
					<div class="col-md-6" id="drawing">
						<h4>Your drawing :</h4>
						<canvas id="canvas2" width="100px" height="100px"></canvas>
						<h4 id="timer"></h4>
					</div>
				</div>
			</div>
				<div id="result" class="col-md-6 text-center">
			</div>
		</div>
	</div>
	<script src="node_modules/jquery/dist/jquery.min.js"></script>
	<script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
	<script src="node_modules/resemblejs/resemble.js"></script>
	<script src="node_modules/mustache/mustache.min.js"></script>
	<script src="js/canvas-to-blob.min.js"></script>
	<script src="http://localhost:8080/socket.io/socket.io.js"></script>
	<script>
	$(function() {
		/*==========  Countdown  ==========*/
		var counter;
		function timer() {
		    if (count <= 0) {
		        clearInterval(counter);
		        return;
		    }
		    count--;
		    displayCount(count);
		}

		function displayCount(count) {
		    var res = count / 100;
		    document.getElementById("timer").innerHTML = res.toPrecision(count.toString().length) + " secs";
		}

		/*==========  Socket  ==========*/
		var socket = io.connect('http://localhost:8080');

		$("#nickname").on('input',function(){
			var nickname = $(this).val();
			socket.emit('nickname',nickname)
		})

		socket.on('drawresults', function(data) {
			data.match = ((1-data.misMatchPercentage/100)*100).toFixed();
			$("#drawing").hide();
			$.get('templates/result.mst', function(template) {
				var rendered = Mustache.render(template,data);
				$('#result').append(rendered);
			});
		});

		socket.on('compare',function(){
			$('#image-diff').html("Resultats");
			compare();
		});

		socket.on('start',function(index,time){
			$("#drawing").show();
			$('#game').show();
			$('#message').hide();
			$('#image-diff').html('');
			$('#result').html('');
			count = time;
			clearInterval(counter);
			counter = setInterval(timer, 10);
			init($('#canvas2'),'#FFF');
			fillRef(index);
		});

		socket.on('stop',function(index){
			$('#image-diff').html('');
			$('#game').hide();
			$('#message').show();
		});

		/*==========  Resemble Options  ==========*/
		resemble.outputSettings({
			errorColor: {
				red: 0,
				green: 0,
				blue: 255
			},
			errorType: 'movement',
			transparency: 0.3,
			largeImageThreshold: 1200
		});

		/*==========  Ref image  ==========*/
		var fillRef = function(index)
		{
			var canvas = document.getElementById('canvas1');
			var ctx = canvas.getContext('2d');
			ctx.fillStyle = "white";
	      	ctx.fillRect(0,0,100,100);
			ctx.fillStyle = "red";
			switch(index)
			{
				case 1:
	      			ctx.fillRect(25,25,50,50);
				break;
				case 2:
					ctx.beginPath();
					ctx.moveTo(10,10);
					ctx.lineTo(90,10);
					ctx.lineTo(50,90);
					ctx.fill();
				break;
				case 3:
				break;
				case 4:
				break;
				case 5:
				break;
			}
		}
      	/*==========  Draw function  ==========*/
      	function init(container, fillColor) {
	        var canvas = container[0];
	        canvas.node = container[0];
	        var ctx = canvas.getContext('2d');
	        // define a custom fillCircle method
	        ctx.fillCircle = function(x, y, radius, fillColor) {
	            this.fillStyle = fillColor;
	            this.beginPath();
	            this.moveTo(x, y);
	            this.arc(x, y, radius, 0, Math.PI * 2, false);
	            this.fill();
	        };
	        ctx.clearTo = function(fillColor) {
	            ctx.fillStyle = fillColor;
	            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
	        };
	        ctx.clearTo(fillColor || "#ddd");

	        // bind mouse events
	        canvas.node.onmousemove = function(e) {
	            if (!canvas.isDrawing) {
	               return;
	            }
	            var x = e.pageX - this.offsetLeft;
	            var y = e.pageY - this.offsetTop;
	            var radius = 3; // or whatever
	            var fillColor = '#ff0000';
	            ctx.fillCircle(x, y, radius, fillColor);
	        };
	        canvas.node.onmousedown = function(e) {
	            canvas.isDrawing = true;
	        };
	        canvas.node.onmouseup = function(e) {
	            canvas.isDrawing = false;
	        };
	    }

		/*==========  Comparison function  ==========*/
		var compare = function()
		{
			var img1 = null;
			var img2 = null;
			var convert1 = function()
			{
				var canvas = document.getElementById('canvas1');
				if (canvas.toBlob) {
				    canvas.toBlob(
				        function (blob1) {
							img1 = blob1;
							convert2();
				        },
				        'image/jpeg'
				    );
				}	
			};

			var convert2 = function()
			{
				var canvas2 = document.getElementById('canvas2');
				if (canvas2.toBlob) {
				    canvas2.toBlob(
				        function (blob2) {
							img2 = blob2;
							resembleControl = resemble(img1).compareTo(img2).ignoreAntialiasing().onComplete(onComplete);
				        },
				        'image/jpeg'
				    );
				}
			}
			convert1();
		}

		function onComplete(data){
			data.getImageDataUrl = data.getImageDataUrl();
			socket.emit('drawed', data);
		};
	});
	</script>
</body>
</html>